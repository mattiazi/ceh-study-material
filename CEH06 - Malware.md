CEH06: Malware
=====

Concetti e tecniche di propagazione Malware
-----

Un **malware** è un software malevolo in grado di creare danni ad un sistema, disabilitare funzionalità e fornire il controllo remoto (limitato o completo) ai creatori stessi, spesso per frodi o furto di dati.

**Tipologie di malware:**

* Trojan horse
* Backdoor
* Rootkit
* Ransomware
* Adware
* Virus
* Worm
* Spyware
* Botnet
* Crypter

#### Tecniche di distribuzione dei Malware sul web
**BLACKHAT SEO**: Permette ai siti contenenti malware di essere tra i primi risultati di ricerca di un motore di ricerca.

**SOCIAL ENGINEERED CLICK-JACKING**: Invogliare l'utente a cliccare la pagina di un malware.

**SPEARPHISHING SITES**: Vengono create copie identiche di siti ufficiali per rubare informazioni (documenti, credenziali, carte di credito).

**DRIVE-BY DOWNLOADS**: Si sfruttano le vulnerabilità dei browser per installare malware nei sistemi.

#### Componenti di un Malware
* **CRYPTER** - Protegge il malware dalla *reverse engineering*.
* **DOWNLOADER** - Trojan che scarica altri malware dalla rete.
* **DROPPER** - Trojan che installa altri malware.
* **EXPLOIT** - Codice malevolo che sfrutta una vulnerabilità per entrare nel sistema.
* **INJECTOR** - Programma che inietta codice all'interno di processi vulnerabili.
* **OBFUSCATOR** - Programma che permette l'offuscamento del codice e degli intenti di un malware, così da rendere difficili la rilevazione e la rimozione.
* **PACKER** - Programma che permette di "pacchettizzare" tutti i file necessari ad un malware in un singolo eseguibile, permette di passare i controlli di sicurezza.
* **PAYLOAD** - Parte di software che permette di ottenere il controllo di un sistema (dopo l'exploit).
* **MALICIOUS CODE** - Comandi che definiscono le funzionalità del malware, come furto di credenziali, creazione backdoor o altre attività malevole.

Panoramica sui Trojan
-----

#### Trojan
Sono molti gli scopi per i quali installare un trojan in un sistema: installare backdoor nei sistemi, disabilitare firewall e antivirus, utilizzare il sistema in una botnet, eliminare o sostituire file critici del S.O. 

#### Wrapper
Un wrapper (involucro) nasconde l'eseguibile trojan all'interno di un eseguibile che sembra genuino. All'avvio del wrapper viene, come prima cosa, installato il trojan contenuto al suo interno.

#### Crypter
È un software utilizzato per nascondere virus, keylogger e altri strumenti per renderli difficilmente individuabili dagli antivirus.

#### Tecniche di evasione antivirus
* Un Trojan può essere suddiviso in pezzi successivamente compressi insieme.
* Scrivere il proprio trojan autonomamente.
* Cambiare il contenuto del trojan con un hex editor, così da cambiare il checksum, cifrare il file. Queste operazioni rompono la firma del file rendendo difficile la detection.

Panoramica su Virus e Worm
-----

I virus sono spesso trasmessi tramite file scaricati, chiavette usb o dischi infetti e allegati via email.

#### Indicatori di infezione

1. I processi richiedono più tempo e risorse
2. Beep del computer senza nessun video
3. I drive cambiano etichetta
4. Il S.O. viene caricato con errori o non viene caricato affatto
5. Avvisi costanti dall'antivirus
6. Il computer si blocca di frequente o restituisce errori come BSOD
7. Mancano file e cartelle
8. L'attività dell'harddisk è sospetta
9. La finestra del browser si blocca
10. Mancanza di spazio su disco
11. Popup di pubblicità inattesi

#### System Virus e File Virus
**System/Boot Sector Virus**: Questa tipologia di virus sposta l'MBR in un'altra posizione del disco e si auto-copia nella posizione originale dell'MBR. All'avvio del sistema viene eseguito il codice del virus e poi il controllo viene passato all'MBR originale.

**Multipartite Virus**: È un virus che infetta sia il *boot sector* che normali file eseguibili.

#### Cluster Virus e Stealth Virus
**Cluster Virus**: Modifica i puntamenti delle cartelle per indirizzare l'utente o il sistema verso il codice malevolo.

**Stealth/Tunneling Virus**: Questa tipologia di virus evade gli antivirus intercettando le chiamate al S.O.

#### Worm
Sono programmi malevoli che si replicano e si eseguono in maniera autonoma attraverso la rete.

Concetti di Malware Analysis
-----

SHEEP DIP COMPUTER: Questo termine si riferisce all'analisi di file sospetti o messaggi alla ricerca di malware. È un ambiente strettamente controllato. 

#### Introduzione alla Malware Analysis
È il processo di *reverse engineering* di un malware al fine di individuare l'origine, le funzionalità e il potenziale impatto sui sistemi.

**STATIC ANALYSIS**: È solo *code analysis*, senza esecuzione. Serve a capire il funzionamento del malware.

**DYNAMIC ANALYSIS**:  Nota anche come *behavior analysis*, esegue il codice malevolo per capire come interagisce e che tipo di impatti potrebbe avere.

#### Ambiente di test per Malware
1. Preparare un sistema (fisico)
2. Installare una VM
3. Isolare la VM dalla rete (NIC in *host only*)
4. Simulare internet con tool appositi come *iNetSim*
5. Disabilitare le cartelle condivise
6. Installare gli strumenti necessari per la Malware Analysis
7. Generare hash per ogni S.O. e tool per analizzare eventuali modifiche
8. Copiare il malware nel S.O. guest. 

#### Metodi di detection
* **SCANNING** - Calcolata la signature viene ricercata in un database, in caso di corrispondenza viene lanciato un alert.
* **INTEGRITY CHECKING** - Legge l'intero disco e "registra" l'integrità dei dati (come le signature).
* **INTERCEPTION** - Monitora le richieste al S.O.
* **CODE EMULATION** - L'antivirus esegue il codice malevolo in una VM (sandbox).
* **HEURISTIC ANALYSIS** - Controlla potenziali funzionalità malevole, attività sospette o system call.
